# netlify.toml (racine)

[build]
  # Ton app Next se trouve dans apps/web
  base    = "apps/web"

  # Nettoyage + install sans scripts (évite postinstall prisma) + prisma generate + build
  command = "rm -f components/ExerciseLink.tsx components/DemoBrowser.tsx && npm ci --no-audit --no-fund --ignore-scripts && npx prisma generate --schema=prisma/schema.prisma && npm run build"

  # Dossier de sortie de Next relatif à base
  publish = ".next"

[build.environment]
  NODE_VERSION = "20"
  NEXT_TELEMETRY_DISABLED = "1"
  NPM_FLAGS = "--no-audit --no-fund"

  # ⚠️ IMPORTANT :
  # Ne mets PAS tes secrets ici avec "".
  # Configure-les dans Netlify > Site settings > Environment variables :
  #
  # - DATABASE_URL
  # - NEXTAUTH_SECRET
  # - SPOTIFY_CLIENT_ID
  # - SPOTIFY_CLIENT_SECRET
  #
  # - NEXT_PUBLIC_VAPID_PUBLIC_KEY
  # - VAPID_PUBLIC_KEY
  # - VAPID_PRIVATE_KEY
  # - VAPID_SUBJECT
  #
  # (et le reste : Supabase, etc.)

[functions]
  # Avec [build].base = "apps/web", tes fonctions vivent dans apps/web/netlify/functions/
  directory = "netlify/functions"
  node_bundler = "esbuild"
  external_node_modules = ["@upstash/redis", "@upstash/ratelimit", "web-push"]

# Optionnel : tu peux aussi forcer le schedule ici (en plus de exports.config dans la function)
[functions."push-cron"]
  schedule = "*/1 * * * *"

[[headers]]
  for = "/api/analyze"
  [headers.values]
    Cache-Control = "no-store, no-transform"
    Connection    = "keep-alive"
    X-Accel-Buffering = "no"

[[plugins]]
  package = "@netlify/plugin-nextjs"
