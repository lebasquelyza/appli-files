datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ========================
// Utilisateurs (annuaire)
// ========================
model AppUser {
  // id = token.sub (id Spotify via NextAuth)
  id        String   @id
  email     String?
  name      String?
  image     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  outgoingFriendRequests FriendRequest[] @relation("FriendRequestRequester")
  incomingFriendRequests FriendRequest[] @relation("FriendRequestAddressee")

  pushSubscriptions PushSubscription[]
}

// ========================
// Amis (sans enum)
// status: "PENDING" | "ACCEPTED" | "DECLINED" | "BLOCKED"
// ========================
model FriendRequest {
  id          String   @id @default(cuid())

  requesterId String
  addresseeId String

  // SQLite: pas d'enum -> String
  status      String   @default("PENDING")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  requester   AppUser  @relation("FriendRequestRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  addressee   AppUser  @relation("FriendRequestAddressee", fields: [addresseeId], references: [id], onDelete: Cascade)

  @@unique([requesterId, addresseeId])
  @@index([addresseeId, status])
  @@index([requesterId, status])
}

// ========================
// Web Push Subscriptions
// ========================
model PushSubscription {
  id        String   @id @default(cuid())

  userId    String
  endpoint  String   @unique
  p256dh    String
  auth      String
  userAgent String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      AppUser  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ========================
// Banque de messages Coach
// ========================
model CoachMotivation {
  id        String   @id @default(cuid())
  lang      String   @default("fr") // "fr" | "en"
  title     String?
  message   String
  active    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([lang, active])
}

// ========================
// Messages programmés
// target: "ME" | "FRIENDS"
// mode:   "COACH" | "CUSTOM"
// ========================
model MotivationMessage {
  id        String   @id @default(cuid())

  userId    String
  target    String
  mode      String

  content   String
  days      String
  time      String

  active    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  recipients MotivationMessageRecipient[]
  dispatches  MotivationDispatch[]

  @@index([userId, active])
  @@index([time])
}

// ========================
// Destinataires sélectionnés
// ========================
model MotivationMessageRecipient {
  id                  String   @id @default(cuid())
  motivationMessageId String
  recipientUserId     String

  createdAt           DateTime @default(now())

  motivationMessage   MotivationMessage @relation(fields: [motivationMessageId], references: [id], onDelete: Cascade)

  @@index([motivationMessageId])
  @@index([recipientUserId])
}

// ========================
// Anti-doublon d'envoi
// sendKey: "YYYY-MM-DD|HH:mm|Europe/Paris"
// ========================
model MotivationDispatch {
  id                  String   @id @default(cuid())
  motivationMessageId String
  sendKey             String
  createdAt           DateTime @default(now())

  motivationMessage   MotivationMessage @relation(fields: [motivationMessageId], references: [id], onDelete: Cascade)

  @@unique([motivationMessageId, sendKey])
  @@index([sendKey])
}
